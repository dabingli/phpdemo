<?php
header("Content-type:text/html;charset=utf-8");
echo '----------------------自签名验证-START----------------------','<br>';
// 测试私钥 秘钥
$privkeypass = '1234qwer'; //私钥密码
$pfxpath = "./merchant.pfx"; //密钥文件路径
$priv_key = file_get_contents($pfxpath); //获取密钥文件内容
$dataJson = '{"charset":"00","version":"1.0","signType":"RSA","service":"AgencyPay","transType":"AGENCY_PAY","merchantId":"872235373925000","orderId":"T1908210801574270002","orderTime":"20190829","transAmt":"9186","currency":"CNY","backParam":"","offlineNotifyUrl":"http://app.kabaitian.com/pay/Paydydf/pay_notify","cardType":"0","cardNo":"6228460718023207773","userNo":"410423198410302511","userType":"01","feePayer":"01","extendInfo":"","merchantSign":"0C2767E3B739D70064185C1842FB656725835766BF36ABD44855D9CC7E756A81089EFA1572B8FFED7DB6873ED1CE860FD1656D788B51D8296D0173BC3D9564266D9EBE8850F483E399DC9AB957E9B8F597D8630A4D36DDA310A3202E6FB1891E6833D42E0897E472F2DF2886FEC22ED05DBC1E0391EA544CC78ACCEFDB55D83C1639D4964A5BAB79E86F588A5A4B6A08B35177248D15ED07F3F7C4CD8D2EE42FB9F3723B9EDABF974FB8BE2389093A2A84D0A6C22F1383BCD381AC0E0CC10EA17751E9AAD09F05B3904B6603AA1B5276C54A2819819A3209250D3E3FCEFC1106BF05FB456A230EDEF4E52F47A3338E89F343D2D85645DF14A023B3881491F30E","merchantCert":"308204F2308203DAA00302010202054112164331300D06092A864886F70D01010B05003058310B300906035504061302434E3130302E060355040A0C274368696E612046696E616E6369616C2043657274696669636174696F6E20417574686F726974793117301506035504030C0E4346434120414353204F43413331301E170D3138303532333038333735305A170D3231303532333038333735305A3081A0310B300906035504061302434E31173015060355040A0C0E4346434120414353204F4341333131133011060355040B0C0A43464341204F4341333131193017060355040B0C104F7267616E697A6174696F6E616C2D313148304606035504030C3F4346434140E4B88AE6B5B7E794B5E993B6E4BFA1E681AFE68A80E69CAFE69C89E99990E585ACE58FB8404E393133313030303035373037363637363130403230820122300D06092A864886F70D01010105000382010F003082010A0282010100A1BCF69716CC5820D691D49E8DE63D2DA2154F11BFE21C8A48571D93D361A4171655145D52686004A2F4740ED408D095CB0DAFF53E23671BDFF8F84B528FEC6DC160B3754808E0543541037A9B5CE2F182ED6C1E5F29DE3C891B22EFA24B52BF27F758F7693DBE37A66F66D453F1622B9B9B38C48487F8522AC05D9580A08747786CA0F5398FFA814B35954004C250EFCD626B52480BA5CB0F0917E6ABDACCBE2DEE117C9345FAD2D5ED283DB8C0B5B0A66BD19E1553D9B1A2AFB3D8A9026856AF84E011A67C8FD1645107E5D3E0DBFB876B347FF25A6EB79B65901C20EBF82171CBE5F8478A86D509F5D091CA0947D4EEAC5B05DF575F27E45601439ED389470203010001A382017830820174306C06082B060105050701010460305E302806082B06010505073001861C687474703A2F2F6F6373702E636663612E636F6D2E636E2F6F637370303206082B060105050730028626687474703A2F2F63726C2E636663612E636F6D2E636E2F6F636133312F6F636133312E636572301F0603551D23041830168014E2B409CBCD61A1734A797FF18A830BDDB47E8C1D300C0603551D130101FF0402300030480603551D200441303F303D060860811C86EF2A01043031302F06082B060105050702011623687474703A2F2F7777772E636663612E636F6D2E636E2F75732F75732D31342E68746D303D0603551D1F043630343032A030A02E862C687474703A2F2F63726C2E636663612E636F6D2E636E2F6F636133312F5253412F63726C313133362E63726C300E0603551D0F0101FF0404030206C0301D0603551D0E04160414043385BE434CCF92D41704B67C2E0A1733F70134301D0603551D250416301406082B0601050507030206082B06010505070304300D06092A864886F70D01010B05000382010100AD1D218D9E30F64E6136EF90D09C391EDFD695EA3CFE3D9245DB07F19C7220ADF7A940EAA482FE1335910AE04C63487D5F82E10AEB1A459FA55462B288B0D1346CB40D29CACADBA9CB1C486255104A5B77A8F90F7B6F9E1D612AA52838D57443DE06354494ACF702C198C4FDEB51C8CEF9ED398CC42E2E4B6D5B6B92D605E2FF1EB8F89B4E884CA28A69CBAEE77EC002024D0E61EEA8550F41EDDBE2F3B6AECF12419364ECCA59A39B45DFE96E1C3C81A42F36597880512B18AD02C436F32729A9CD405E2773E7616032FADD4A89BEB3C2151312B08A0C110EA5B7F80FE01E0D33EEF511EDB4D8685C0568D0462F747D1B95E5B367E3A1DC4094500C1620D59F"}';



$data = json_decode($dataJson, 1); //加密数据测试test
ksort($data);
$str = '';
foreach ($data as $key => $value) {
	if($key == 'merchantCert' || $key == 'serverCert' || $key == 'merchantSign'){
		continue;
	}
	if($value == ''){
		continue;
	}
	if($str != '') $str .= '&';

	$str .= $key .'='. $value;
}

//私钥加密
openssl_pkcs12_read($priv_key, $certs, $privkeypass); //读取公钥、私钥
// echo '<pre>';
// var_dump($certs);die;
$prikeyid = $certs['pkey']; //私钥
openssl_sign($str, $signMsg, $prikeyid, OPENSSL_ALGO_SHA256); //注册生成加密信息

$merchantSign = strtoupper(bin2hex($signMsg));
echo '----------------------merchantSign----------------------','<br>';
var_dump($merchantSign);
echo '----------------------merchantCert----------------------','<br>';
$cert = $certs['cert'];
$merchantCert = str_replace(['-----BEGIN CERTIFICATE-----','-----END CERTIFICATE-----'],"",$cert);
$merchantCert = base64_decode($merchantCert,1);
$merchantCert = strtoupper(bin2hex($merchantCert));
var_dump($merchantCert);die;
